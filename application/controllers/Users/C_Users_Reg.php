<?phpinclude_once('application/models/M_Users.php');include_once('application/controllers/C_Base.php');	//Контролер реєстрації користувачаclass C_Users_Reg extends C_Base{		private $err;	private $newUser;	//	// Конструктор	//	function __construct() {		$this->err = array();		$this->newUser = array();	}		// Обробник запиту	protected function OnInput()	{		parent::OnInput();				$mUsers = M_Users::Instance();		$mUsers->Logout();							$this->user = null;		$this->title = 'Реєстрація користувача';				// Обробка відправки форми		if(!empty($_POST)) {			$this->err = array();			//перевірка логіна			$this->newUser['login'] = trim($_POST['login']);			if(!preg_match("/^[a-zA-Z0-9]+$/", $this->newUser['login'])) {				$this->err[] = "Логін повинен містити лише літери англійського алфавіту та цифри";			}						if(strlen($this->newUser['login']) < 6 or strlen($this->newUser['login']) > 12) {				$this->err[] = "Логін повинен бути не менше 6-ти символів та не більше 12";			}			// перевірка чи не існує користувача з таким ім'ям 			if($mUsers->CountByLogin($this->newUser['login']) != 0) {				$this->err[] = "Користувач з таким логіном вже існує";			}			$this->newUser['name'] = trim($_POST['name']);						if(strlen($this->newUser['name']) < 2) {				$this->err[] = "Ім'я має складатись не менш ніж з 2-х символів";			}						$pass = trim($_POST['password']);			if($pass != trim($_POST['password_verify'])) {				$this->err[] = "Введені паролі не співпадають";			}			if(strlen($pass) < 6) {				$this->err[] = "Довжина пароля не перевищує 6-ти символів";			}			if(!preg_match("/^[a-zA-Z0-9]+$/", $pass)) {				$this->err[] = "Пароль повинен містити лише літери англійського алфавіту та цифри";			}						$this->newUser['email'] = trim($_POST['email']);			if(!preg_match("/^[\.A-z0-9_\-]+[@][A-z0-9_\-]+([.][A-z0-9_\-]+)+[A-z]{1,4}$/", $this->newUser['email'])) {				$this->err[] = "Ви ввели невірну e-mail адресу";			}			// перевірка чи не існує користувача з такою поштовою скринькой			$userByMail = $mUsers->GetByMail($this->newUser['email']);				if(isset($userByMail['id']) && count($userByMail['id']) != 0) {				$this->err[] = "Користувач з такою електронною скринькою вже зареєстрований";			}        $this->newUser['kod'] = trim($_POST['kod']);				// TODO зробити валідацію        $this->newUser['fam'] = trim($_POST['fam']);        // TODO зробити валідацію        $this->newUser['otch'] = trim($_POST['otch']);        // TODO зробити валідацію			// Якщо помилки відсутні, то додаєм до БД нового користувача			if(count($this->err) == 0)			{			    $mUsers->AddUser($this->newUser['login'], $pass, $this->newUser['email'], $this->newUser['fam'], $this->newUser['name'], $this->newUser['otch'], 1, $this->newUser['kod'], '');				$mail = "Добрий день,   ".$_POST['name']."\nДякуєм Вам за реєстрацію на нашому сайті.\n\nЯкщо у Вас виникли питання чи пропозиції - звертайтесь до\nЦентру обслуговування платників\n\n______________________________________________________________\nЦей лист відправлено в автоматичному режимі. Відповідати на нього не потрібно.\nГарного дня.\nЦентр обслуговування платників\n";				mail($this->newUser['email'], 'Реєстрація нового користувача	', $mail);				header("Location: /profile"); die();			}		}		else {			$this->newUser['login'] = '';			$this->newUser['name'] = '';			$this->newUser['email'] = '';		}	}		// Генератор HTML	protected function OnOutput()	{		$vars = array('user' => $this->newUser, 'errs' => $this->err);		$this->content = $this->View('templates/theme/v_reg.php', $vars);		parent::OnOutput();	}		}